<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetroControl | Mantenimiento</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Orden correcto -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="api.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-gas-pump"></i>
                <h2>PetroControl</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="dashboard.html">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Panel</span>
                        </a>
                    </li>
                    <li>
                        <a href="registro.html">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Registro E/S</span>
                        </a>
                    </li>
                    <li>
                        <a href="inventario.html">
                            <i class="fas fa-warehouse"></i>
                            <span>Inventario</span>
                        </a>
                    </li>
                    <li>
                        <a href="camiones.html">
                            <i class="fas fa-truck"></i>
                            <span>Camiones</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="mantenimiento.html">
                            <i class="fas fa-tools"></i>
                            <span>Mantenimiento</span>
                        </a>
                    </li>
                    <li>
                        <a href="camioneros.html">
                            <i class="fas fa-users"></i>
                            <span>Camioneros</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Cerrar Sesi√≥n</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-header">
                <h1>Gesti√≥n de Mantenimiento</h1>
                <div class="user-info">
                    <span id="user-name">Cargando...</span>
                    <i class="fas fa-user-circle"></i>
                </div>
            </div>

            <div class="content-box">
                <!-- Barra de acciones -->
                <div class="actions-bar">
                    <button id="add-mantenimiento-btn" class="btn-primary">
                        <i class="fas fa-plus"></i> Programar Mantenimiento
                    </button>
                </div>

                <!-- Estad√≠sticas de mantenimiento -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-calendar-check"></i>
                        <div>
                            <h3>Programados</h3>
                            <p id="mantenimientos-programados">-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-cog"></i>
                        <div>
                            <h3>En Proceso</h3>
                            <p id="mantenimientos-proceso">-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <h3>Completados</h3>
                            <p id="mantenimientos-completados">-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-dollar-sign"></i>
                        <div>
                            <h3>Costo Total</h3>
                            <p id="costo-total">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de mantenimientos -->
                <div class="mantenimientos-section">
                    <h3><i class="fas fa-list"></i> Lista de Mantenimientos</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cami√≥n</th>
                                    <th>Tipo</th>
                                    <th>Descripci√≥n</th>
                                    <th>Fecha Ingreso</th>
                                    <th>Fecha Salida</th>
                                    <th>Costo Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="mantenimientos-table-body">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando mantenimientos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para programar mantenimiento -->
    <div id="mantenimiento-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Programar Mantenimiento</h2>
                <button class="close-modal" onclick="cerrarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="mantenimiento-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="camion-select">
                                <i class="fas fa-truck"></i> Cami√≥n:
                            </label>
                            <select id="camion-select" required>
                                <option value="">Seleccionar cami√≥n...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tipo-mantenimiento">
                                <i class="fas fa-cog"></i> Tipo:
                            </label>
                            <select id="tipo-mantenimiento" required>
                                <option value="">Seleccionar tipo...</option>
                                <option value="preventivo">Preventivo</option>
                                <option value="correctivo">Correctivo</option>
                                <option value="emergencia">Emergencia</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="descripcion">
                            <i class="fas fa-clipboard"></i> Descripci√≥n:
                        </label>
                        <textarea id="descripcion" placeholder="Descripci√≥n del mantenimiento" rows="3" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha-ingreso">
                                <i class="fas fa-calendar"></i> Fecha de Ingreso:
                            </label>
                            <input type="date" id="fecha-ingreso" required>
                        </div>
                        <div class="form-group">
                            <label for="taller">
                                <i class="fas fa-building"></i> Taller:
                            </label>
                            <input type="text" id="taller" placeholder="Nombre del taller">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="costo-mano-obra">
                                <i class="fas fa-dollar-sign"></i> Costo Mano de Obra:
                            </label>
                            <input type="number" id="costo-mano-obra" min="0" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="costo-repuestos">
                                <i class="fas fa-dollar-sign"></i> Costo Repuestos:
                            </label>
                            <input type="number" id="costo-repuestos" min="0" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="observaciones-mant">
                            <i class="fas fa-comment"></i> Observaciones:
                        </label>
                        <textarea id="observaciones-mant" placeholder="Observaciones adicionales" rows="2"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="cerrarModal()">Cancelar</button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Programar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para completar mantenimiento -->
    <div id="completar-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Completar Mantenimiento</h2>
                <button class="close-modal" onclick="cerrarModalCompletar()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="completar-form">
                    <div class="form-group">
                        <label for="fecha-salida">
                            <i class="fas fa-calendar"></i> Fecha de Salida:
                        </label>
                        <input type="date" id="fecha-salida" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="costo-final-mano-obra">
                                <i class="fas fa-dollar-sign"></i> Costo Final Mano de Obra:
                            </label>
                            <input type="number" id="costo-final-mano-obra" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="costo-final-repuestos">
                                <i class="fas fa-dollar-sign"></i> Costo Final Repuestos:
                            </label>
                            <input type="number" id="costo-final-repuestos" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="observaciones-final">
                            <i class="fas fa-comment"></i> Observaciones Finales:
                        </label>
                        <textarea id="observaciones-final" placeholder="Observaciones del trabajo realizado" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="cerrarModalCompletar()">Cancelar</button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-check"></i> Completar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let mantenimientoCompletando = null;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina de mantenimiento cargada');
            
            const token = localStorage.getItem("token");
            if (!token) {
                alert("No est√°s autenticado. Redirigiendo al login...");
                window.location.href = "index.html";
                return;
            }
            
            try {
                const decoded = JSON.parse(atob(token));
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    userNameElement.textContent = decoded.username || 'Usuario';
                }
            } catch (error) {
                console.error('‚ùå Error decodificando token:', error);
                localStorage.removeItem('token');
                window.location.href = 'index.html';
                return;
            }

            inicializarPagina();
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        function inicializarPagina() {
            cargarMantenimientos();
            cargarCamionesParaSelect();
            
            document.getElementById('add-mantenimiento-btn').addEventListener('click', abrirModal);
            document.getElementById('mantenimiento-form').addEventListener('submit', programarMantenimiento);
            document.getElementById('completar-form').addEventListener('submit', completarMantenimiento);
            
            // Establecer fecha actual
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha-ingreso').value = hoy;
            document.getElementById('fecha-salida').value = hoy;
        }

        async function cargarMantenimientos() {
            try {
                const token = localStorage.getItem("token");
                const response = await fetch('http://localhost:3000/api/mantenimientos', {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (!response.ok) throw new Error(`Error ${response.status}`);

                const data = await response.json();
                const mantenimientos = data.mantenimientos || [];
                
                mostrarMantenimientos(mantenimientos);
                actualizarEstadisticas(mantenimientos);

            } catch (error) {
                console.error('‚ùå Error al cargar mantenimientos:', error);
                mostrarError('Error al cargar mantenimientos: ' + error.message);
            }
        }

        async function cargarCamionesParaSelect() {
            try {
                const token = localStorage.getItem("token");
                const response = await fetch('http://localhost:3000/api/camiones', {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (!response.ok) throw new Error(`Error ${response.status}`);

                const data = await response.json();
                const camiones = data.camiones || [];
                
                const select = document.getElementById('camion-select');
                select.innerHTML = '<option value="">Seleccionar cami√≥n...</option>';
                
                camiones.forEach(camion => {
                    const option = document.createElement('option');
                    option.value = camion.camionId;
                    option.textContent = `${camion.camionId} - ${camion.marca} ${camion.modelo}`;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('‚ùå Error al cargar camiones:', error);
            }
        }

        function mostrarMantenimientos(mantenimientos) {
            const tbody = document.getElementById('mantenimientos-table-body');
            
            if (mantenimientos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                            üìã No hay mantenimientos registrados
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = mantenimientos.map(mant => {
                const fechaIngreso = new Date(mant.fechaIngreso).toLocaleDateString('es-ES');
                const fechaSalida = mant.fechaSalida ? new Date(mant.fechaSalida).toLocaleDateString('es-ES') : '-';
                
                const estadoClass = {
                    'programado': 'badge-info',
                    'en_proceso': 'badge-warning',
                    'completado': 'badge-success',
                    'cancelado': 'badge-error'
                }[mant.estado] || 'badge-info';

                const estadoIcon = {
                    'programado': 'fas fa-calendar',
                    'en_proceso': 'fas fa-cog fa-spin',
                    'completado': 'fas fa-check-circle',
                    'cancelado': 'fas fa-times-circle'
                }[mant.estado] || 'fas fa-info-circle';

                return `
                    <tr>
                        <td><strong>${mant.camionId}</strong></td>
                        <td>${mant.tipoMantenimiento}</td>
                        <td>${mant.descripcion}</td>
                        <td>${fechaIngreso}</td>
                        <td>${fechaSalida}</td>
                        <td><strong>$${Number(mant.costoTotal || 0).toFixed(2)}</strong></td>
                        <td>
                            <span class="badge ${estadoClass}">
                                <i class="${estadoIcon}"></i> ${mant.estado}
                            </span>
                        </td>
                        <td>
                            ${mant.estado === 'en_proceso' || mant.estado === 'programado' ? 
                                `<button class="btn-icon btn-success" onclick="abrirModalCompletar(${mant.id}, '${mant.camionId}')" title="Completar">
                                    <i class="fas fa-check"></i>
                                </button>` : 
                                '<span style="color: #ccc;">-</span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function actualizarEstadisticas(mantenimientos) {
            const programados = mantenimientos.filter(m => m.estado === 'programado').length;
            const enProceso = mantenimientos.filter(m => m.estado === 'en_proceso').length;
            const completados = mantenimientos.filter(m => m.estado === 'completado').length;
            const costoTotal = mantenimientos.reduce((total, m) => total + (m.costoTotal || 0), 0);

            document.getElementById('mantenimientos-programados').textContent = programados;
            document.getElementById('mantenimientos-proceso').textContent = enProceso;
            document.getElementById('mantenimientos-completados').textContent = completados;
            document.getElementById('costo-total').textContent = `$${costoTotal.toFixed(2)}`;
        }

        function abrirModal() {
            const modal = document.getElementById('mantenimiento-modal');
            modal.style.display = 'flex';
        }

        function cerrarModal() {
            const modal = document.getElementById('mantenimiento-modal');
            modal.style.display = 'none';
            document.getElementById('mantenimiento-form').reset();
        }

        function abrirModalCompletar(id, camionId) {
            mantenimientoCompletando = id;
            const modal = document.getElementById('completar-modal');
            modal.style.display = 'flex';
        }

        function cerrarModalCompletar() {
            const modal = document.getElementById('completar-modal');
            modal.style.display = 'none';
            document.getElementById('completar-form').reset();
            mantenimientoCompletando = null;
        }

        async function programarMantenimiento(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Programando...';
            submitBtn.disabled = true;

            try {
                const token = localStorage.getItem("token");
                const data = {
                    camionId: document.getElementById('camion-select').value,
                    tipoMantenimiento: document.getElementById('tipo-mantenimiento').value,
                    descripcion: document.getElementById('descripcion').value,
                    fechaIngreso: document.getElementById('fecha-ingreso').value,
                    taller: document.getElementById('taller').value,
                    costoManoObra: parseFloat(document.getElementById('costo-mano-obra').value) || 0,
                    costoRepuestos: parseFloat(document.getElementById('costo-repuestos').value) || 0,
                    observaciones: document.getElementById('observaciones-mant').value
                };

                const response = await fetch('http://localhost:3000/api/mantenimientos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error ${response.status}`);
                }

                cerrarModal();
                await cargarMantenimientos();
                showMessage('‚úÖ Mantenimiento programado exitosamente', 'success');

            } catch (error) {
                console.error('‚ùå Error al programar mantenimiento:', error);
                showMessage('‚ùå Error: ' + error.message, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function completarMantenimiento(event) {
            event.preventDefault();
            
            if (!mantenimientoCompletando) return;

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Completando...';
            submitBtn.disabled = true;

            try {
                const token = localStorage.getItem("token");
                const data = {
                    fechaSalida: document.getElementById('fecha-salida').value,
                    costoManoObra: parseFloat(document.getElementById('costo-final-mano-obra').value),
                    costoRepuestos: parseFloat(document.getElementById('costo-final-repuestos').value),
                    observaciones: document.getElementById('observaciones-final').value
                };

                const response = await fetch(`http://localhost:3000/api/mantenimientos/${mantenimientoCompletando}/completar`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error ${response.status}`);
                }

                cerrarModalCompletar();
                await cargarMantenimientos();
                showMessage('‚úÖ Mantenimiento completado exitosamente', 'success');

            } catch (error) {
                console.error('‚ùå Error al completar mantenimiento:', error);
                showMessage('‚ùå Error: ' + error.message, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        function mostrarError(mensaje) {
            const tbody = document.getElementById('mantenimientos-table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px; color: red;">
                        ‚ùå ${mensaje}
                    </td>
                </tr>
            `;
        }

        function showMessage(message, type = "info") {
            const existingMessages = document.querySelectorAll(".floating-message");
            existingMessages.forEach((msg) => msg.remove());

            const messageDiv = document.createElement("div");
            messageDiv.className = `floating-message message-${type}`;
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">√ó</button>
                </div>
            `;

            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 12px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                max-width: 400px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease-out;
            `;

            if (type === "success") {
                messageDiv.style.backgroundColor = "#4caf50";
            } else if (type === "error") {
                messageDiv.style.backgroundColor = "#f44336";
            } else {
                messageDiv.style.backgroundColor = "#2196f3";
            }

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = "slideIn 0.3s ease-out reverse";
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300);
                }
            }, 5000);
        }
    </script>

    <!-- Estilos CSS para centrar los modales correctamente -->
    <style>
        .btn-success {
    background: #4caf50;
}
.btn-success:hover {
    background: #45a049;
}
.mantenimientos-section {
    margin-top: 30px;
}
.mantenimientos-section h3 {
    color: var(--primary-color);
    margin-bottom: 20px;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 0;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    margin: 0;
    transform: none;
}

.modal-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 20px;
    border-radius: 15px 15px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
}

.close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.3s ease;
}

.close-modal:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.modal-body {
    padding: 25px;
}

.badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.badge-success { 
    background-color: #4caf50; 
    color: white; 
}

.badge-warning { 
    background-color: #ff9800; 
    color: white; 
}

.badge-error { 
    background-color: #f44336; 
    color: white; 
}

.badge-info { 
    background-color: #2196f3; 
    color: white; 
}

.btn-icon {
    padding: 8px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 35px;
    height: 35px;
}

.actions-bar {
    margin-bottom: 30px;
    display: flex;
    justify-content: flex-start;
    gap: 15px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Responsive */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        max-width: none;
    }
    
    .modal {
        padding: 20px;
        box-sizing: border-box;
    }
}
    </style>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        console.log("Iniciando carga de p√°gina...");

        if (!AuthManager.isAuthenticated()) {
            console.warn("No autenticado ‚Üí redirigiendo");
            AuthManager.redirectToLogin();
            return;
        }

        const user = AuthManager.getCurrentUser();
        console.log("Usuario actual:", user); // ‚Üê Ver√°s el role aqu√≠

        const userNameElement = document.getElementById("user-name");
        if (userNameElement) {
            userNameElement.textContent = user?.username || "Usuario";
        }

        try {
            // Carga espec√≠fica
            if (typeof cargarMantenimientos === "function") await cargarMantenimientos();
            if (typeof cargarCamioneros === "function") await cargarCamioneros();

            console.log("Datos cargados correctamente");
        } catch (error) {
            console.error("Error detallado del backend:", error.message);

            // Muestra el error real del backend
            alert("Error del servidor: " + error.message);

            // Solo redirige si es sesi√≥n expirada o token inv√°lido
            if (error.message.includes("401") || error.message.includes("autorizado") || error.message.includes("expirada")) {
                AuthManager.redirectToLogin();
            }
        }
    });
</script>
</body>
</html>
